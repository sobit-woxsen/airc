// Prisma schema for Admin & Engineer Portal System

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  ENGINEER
}

enum ProjectStatus {
  DRAFT
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum MediaType {
  IMAGE
  VIDEO
}

enum DocumentType {
  WHITEPAPER
  DOCUMENTATION
  RESEARCH
  OTHER
}

enum ContactSubject {
  BOOTCAMP
  COLLABORATION
  CONSULTING
  PRESS
  OTHER
}

enum ContactStatus {
  NEW
  READ
  RESPONDED
  ARCHIVED
}

// ============================================
// USER & AUTH MODELS (Better Auth Compatible)
// ============================================

model User {
  id           String      @id @default(cuid())
  name         String
  email        String      @unique
  password     String? // Hashed password for email/password auth
  designation  String? // User's job title or designation
  roles        Role[]      @default([ENGINEER])
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  projects    Project[]
  newsletters Newsletter[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Better Auth fields
  emailVerified Boolean   @default(false)
  image         String?
  accounts      Account[]
  sessions      Session[]

  @@index([email])
  @@index([departmentId])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@index([identifier])
}

// ============================================
// DEPARTMENT MODEL
// ============================================

model Department {
  id              String  @id @default(cuid())
  name            String  @unique
  slug            String  @unique
  description     String
  longDescription String  @db.Text
  icon            String // Lucide icon name
  color           String
  image           String
  videoUrl        String?

  users    User[]
  projects ProjectDepartment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

// ============================================
// PROJECT MODELS
// ============================================

model Project {
  id   String @id @default(cuid())
  name String

  tagline     String
  description String @db.Text
  image       String // Main cover image URL (Cloudinary)

  tags          String[]
  status        ProjectStatus @default(DRAFT)
  productStatus String        @default("Alpha") // "Production" | "Beta" | "Alpha" | "Coming Soon"
  technologies  String[]

  demoUrl    String?
  githubUrl  String?
  docUrl     String?
  previewUrl String?

  // Submission & Approval Tracking
  submittedById String?
  submittedBy   User?     @relation(fields: [submittedById], references: [id], onDelete: SetNull)
  submittedAt   DateTime?
  reviewedAt    DateTime?
  reviewNotes   String?   @db.Text

  // Relations
  departments ProjectDepartment[]
  media       MediaItem[]
  documents   Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([submittedById])
  @@index([status])
}

// Many-to-many relationship between Projects and Departments
model ProjectDepartment {
  id           String     @id @default(cuid())
  projectId    String
  departmentId String
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([projectId, departmentId])
  @@index([projectId])
  @@index([departmentId])
}

model MediaItem {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  type      MediaType
  url       String // Cloudinary URL
  thumbnail String? // For videos, optional custom thumbnail
  alt       String?
  order     Int       @default(0)

  createdAt DateTime @default(now())

  @@index([projectId])
}

model Document {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title String
  url   String // Cloudinary URL
  type  DocumentType @default(OTHER)
  order Int          @default(0)

  createdAt DateTime @default(now())

  @@index([projectId])
}

// ============================================
// SUBSCRIBER MODEL
// ============================================

model Subscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

// ============================================
// NEWSLETTER MODEL
// ============================================

model Newsletter {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  date        String   // "August 2025" format
  issue       Int      @unique

  // Cloudinary URLs
  coverImage  String
  pdfUrl      String

  topics      String[]
  featured    Boolean  @default(false)
  published   Boolean  @default(true)
  publishedAt DateTime @default(now())

  // Audit trail
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([issue])
  @@index([featured])
  @@index([published])
  @@index([createdById])
}

// ============================================
// CONTACT MODEL
// ============================================

model Contact {
  id        String         @id @default(cuid())
  firstName String
  lastName  String
  email     String
  subject   ContactSubject
  message   String         @db.Text
  status    ContactStatus  @default(NEW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([email])
}
